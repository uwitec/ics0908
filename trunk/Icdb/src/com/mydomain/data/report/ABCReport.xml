<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="CheckStock">

	<select id="selectAllABCReportBean" resultClass="com.mydomain.bean.report.ABCReportBean">
		SELECT E.MATERIELNAME AS name,
		E.MATERIELSIZE AS specification,
		E.MATERIELABC AS materielType,
		A.CSCHECKNUMBER AS amount,
		A.CSCHECKPRICE AS price,
		B.CSCHECKNUMBER AS lastAmount,
		B.CSCHECKPRICE
		AS lastPrice,
		C.STOCKINAMOUNT AS inAmount,
		C.STOCKINPRICE AS inPrice,
		D.STOCKOUTAMOUNT AS outAmount,
		D.STOCKOUTPRICE AS outPrice from
		(
		SELECT
		SUM(CHECKSTOCKLIST.CSCHECKNUMBER)
		CSCHECKNUMBER,
		AVG(CHECKSTOCKLIST.CSCHECKPRICE) CSCHECKPRICE,
		CSCODE,
		MATERIELCODE
		FROM
		CHECKSTOCKLIST
		WHERE
		CSCODE = #csCode#
		GROUP BY
		MATERIELCODE
		) A

		LEFT JOIN
		(
		SELECT
		SUM(CHECKSTOCKLIST.CSCHECKNUMBER) CSCHECKNUMBER,
		AVG(CHECKSTOCKLIST.CSCHECKPRICE) CSCHECKPRICE,
		CSCODE,
		MATERIELCODE
		FROM
		CHECKSTOCKLIST
		WHERE
		CSCODE = #oldCsCode#
		GROUP BY
		MATERIELCODE
		) B
		ON
		A.MATERIELCODE = B.MATERIELCODE

		LEFT JOIN
		(
		SELECT MATERIELCODE,
		SUM(STOCKINAMOUNT) AS STOCKINAMOUNT,
		AVG(ONEPRICE)
		STOCKINPRICE FROM
		STOCKINCHECKMATERIEL WHERE STOCKINCODE
		IN
		(
		SELECT STOCKINCODE FROM
		STOCKINCHECKORDER WHERE <![CDATA[STOCKINDATE >= #beginDate#]]>
		AND <![CDATA[STOCKINDATE < #endDate#]]>
		) AND CARGOSPACECODE IN
		(
		SELECT CARGOSPACECODE FROM CHECKSTOCKLIST
		WHERE CSCODE = '2'
		)
		GROUP BY
		MATERIELCODE
		) C
		ON A.MATERIELCODE =
		C.MATERIELCODE
		LEFT JOIN
		(
		SELECT MATERIELCODE, SUM(STOCKOUTAMOUNT) AS
		STOCKOUTAMOUNT,
		AVG(STOCKOUTPRICE) STOCKOUTPRICE FROM
		STOCKOUTHASMATERIEL WHERE
		STOCKOUTORDERCODE IN
		(
		SELECT STOCKOUTORDERCODE
		FROM STOCKOUTORDER WHERE <![CDATA[STOCKOUTDATE >=
		#beginDate#]]>
		AND
		<![CDATA[STOCKOUTDATE < #endDate#]]>
		) AND CARGOSPACECODE IN
		(
		SELECT
		CARGOSPACECODE FROM CHECKSTOCKLIST WHERE
		CSCODE = #csCode#
		)
		GROUP BY
		MATERIELCODE
		) D
		ON A.MATERIELCODE =
		D.MATERIELCODE
		LEFT JOIN
		(
		SELECT
		MATERIELNAME,
		MATERIELSIZE,MATERIELABC,MATERIELCODE
		FROM MATERIEL
		) E
		ON A.MATERIELCODE
		= E.MATERIELCODE
	</select>

	<select id="queryABCReportBean" resultClass="com.mydomain.bean.report.ABCReportBean">
		SELECT E.MATERIELNAME AS name,
		E.MATERIELSIZE AS specification,
		E.MATERIELABC AS materielType,
		A.CSCHECKNUMBER AS amount,
		A.CSCHECKPRICE AS price,
		B.CSCHECKNUMBER AS lastAmount,
		B.CSCHECKPRICE
		AS lastPrice,
		C.STOCKINAMOUNT AS inAmount,
		C.STOCKINPRICE AS inPrice,
		D.STOCKOUTAMOUNT AS outAmount,
		D.STOCKOUTPRICE AS outPrice from
		(
		SELECT
		SUM(CHECKSTOCKLIST.CSCHECKNUMBER)
		CSCHECKNUMBER,
		AVG(CHECKSTOCKLIST.CSCHECKPRICE) CSCHECKPRICE,
		CSCODE,
		MATERIELCODE
		FROM
		CHECKSTOCKLIST
		WHERE
		CSCODE = #csCode#
		GROUP BY
		MATERIELCODE
		) A

		LEFT JOIN
		(
		SELECT
		SUM(CHECKSTOCKLIST.CSCHECKNUMBER) CSCHECKNUMBER,
		AVG(CHECKSTOCKLIST.CSCHECKPRICE) CSCHECKPRICE,
		CSCODE,
		MATERIELCODE
		FROM
		CHECKSTOCKLIST
		WHERE
		CSCODE = #oldCsCode#
		GROUP BY
		MATERIELCODE
		) B
		ON
		A.MATERIELCODE = B.MATERIELCODE

		LEFT JOIN
		(
		SELECT MATERIELCODE,
		SUM(STOCKINAMOUNT) AS STOCKINAMOUNT,
		AVG(ONEPRICE)
		STOCKINPRICE FROM
		STOCKINCHECKMATERIEL WHERE STOCKINCODE
		IN
		(
		SELECT STOCKINCODE FROM
		STOCKINCHECKORDER WHERE <![CDATA[STOCKINDATE >= #beginDate#]]>
		AND <![CDATA[STOCKINDATE < #endDate#]]>
		) AND CARGOSPACECODE IN
		(
		SELECT CARGOSPACECODE FROM CHECKSTOCKLIST
		WHERE CSCODE = '2'
		)
		GROUP BY
		MATERIELCODE
		) C
		ON A.MATERIELCODE =
		C.MATERIELCODE
		LEFT JOIN
		(
		SELECT MATERIELCODE, SUM(STOCKOUTAMOUNT) AS
		STOCKOUTAMOUNT,
		AVG(STOCKOUTPRICE) STOCKOUTPRICE FROM
		STOCKOUTHASMATERIEL WHERE
		STOCKOUTORDERCODE IN
		(
		SELECT STOCKOUTORDERCODE
		FROM STOCKOUTORDER WHERE <![CDATA[STOCKOUTDATE >=
        #beginDate#]]>
		AND
        <![CDATA[STOCKOUTDATE < #endDate#]]>
		) AND CARGOSPACECODE IN
		(
		SELECT
		CARGOSPACECODE FROM CHECKSTOCKLIST WHERE
		CSCODE = #csCode#
		)
		GROUP BY
		MATERIELCODE
		) D
		ON A.MATERIELCODE =
		D.MATERIELCODE
		LEFT JOIN
		(
		SELECT
		MATERIELNAME,
		MATERIELSIZE,MATERIELABC,MATERIELCODE
		FROM MATERIEL
		) E
		ON A.MATERIELCODE
		= E.MATERIELCODE
		WHERE E.MATERIELABC = #materielType#
	</select>
</sqlMap>